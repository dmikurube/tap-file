<!doctype html>
<html>
<head>
<style>
* {
  margin:0px;
  padding:0px;
}
</style>
</head>
<body>
<h1>Tap text</h1>
<div id="status" style="border:1px;"></div>
<div id="milliseconds">
</div>
<input type="text" id="inputtext" name="inputtext" size="80"></input>
<div id="current"></div>
<script>
function errorHandler(e) {
      var msg = '';
      switch (e.code) {
        case FileError.QUOTA_EXCEEDED_ERR:
          msg = 'QUOTA_EXCEEDED_ERR';
          break;
        case FileError.NOT_FOUND_ERR:
          msg = 'NOT_FOUND_ERR';
          break;
        case FileError.SECURITY_ERR:
          msg = 'SECURITY_ERR';
          break;
        case FileError.INVALID_MODIFICATION_ERR:
          msg = 'INVALID_MODIFICATION_ERR';
          break;
        case FileError.INVALID_STATE_ERR:
          msg = 'INVALID_STATE_ERR';
          break;
        default:
          msg = 'Unknown Error';
          break;
      };
      console.log("error:" + msg);
    }

function to_json(milliseconds, inputtext) {
  var json = "{ seconds: [";
  for (var index in milliseconds) {
    if (index > 0) json += ', ';
    json += milliseconds[index];
  }
  json += '], inputtext: "' + inputtext + '" }';
  console.log(json);
  return json;
}

function add_write(fs, existing, milliseconds, inputtext) {
  fs.root.getFile('tapfile.txt', {create: true, exclusive: false}, function(fileEntry) {
    fileEntry.createWriter(function(fileWriter) {
      fileWriter.onerror = function(e) {
        errorHandler(e.currentTarget.error);
      };
      console.log("truncating");
      fileWriter.truncate(0);
      console.log("truncated");
    }, errorHandler);
  }, errorHandler);

  var bb = new (window.BlobBuilder || window.WebKitBlobBuilder)();
  var evaled = eval(existing);
  console.log(evaled);
  bb.append('{\n  entries: [\n');
  for (var ent in evaled) {
    bb.append('      ' + to_json(evaled[ent]["seconds"], evaled[ent]["inputtext"]) + ',\n');
  }
  bb.append('      ' + to_json(milliseconds, inputtext) + ',\n  ]\n}');
  var blob = bb.getBlob();

  console.log("blob made");

  fs.root.getFile('tapfile.txt', {create: true, exclusive: false}, function(fileEntry) {
    fileEntry.createWriter(function(fileWriter) {
      fileWriter.onerror = function(e) {
        errorHandler(e.currentTarget.error);
      };
      console.log("writing");
      fileWriter.write(blob);
      console.log("written");
    }, errorHandler);
  }, errorHandler);

  chrome.extension.sendRequest({"type" : "init"});
}

function create_or_clear_fs_init(fs) {
  fs.root.getFile('tapfile.txt', {create: true, exclusive: false}, function(fileEntry) {
    fileEntry.createWriter(function(fileWriter) {
      fileWriter.onerror = function(e) {
        errorHandler(e.currentTarget.error);
      };
      fileWriter.truncate(0);
    }, errorHandler);
  }, errorHandler);
}

function add_data_fs_init(fs, milliseconds, inputtext) {
  console.log("Init");

  fs.root.getFile('tapfile.txt', {create: false, exclusive: false}, function(fileEntry) {
    fileEntry.file(function(file) {
      console.log("reading");
      var reader = new FileReader();
      reader.onloadend = function(e) {
        console.log("read");
        console.log(this.result);
        add_write(fs, this.result, milliseconds, inputtext);
      };
      reader.readAsText(file);
    }, function(e) { console.log("Read1:"); errorHandler(e); add_write(fs, "", [931, 49], "Add 2"); } )
  }, function(e) { console.log("Read2:"); errorHandler(e); add_write(fs, "", [294], "Add 3"); } );
}

function get_data_fs_init(fs, callback) {
  console.log("Init");

  fs.root.getFile('tapfile.txt', {create: false, exclusive: false}, function(fileEntry) {
    fileEntry.file(function(file) {
      console.log("reading");
      var reader = new FileReader();
      reader.onloadend = function(e) {
        console.log("read");
        console.log(this.result);
        callback(eval(this.result));
      };
      reader.readAsText(file);
    }, function(e) { console.log("Read1:"); errorHandler(e); add_write(fs, "", [931, 49], "Add 2"); } )
  }, function(e) { console.log("Read2:"); errorHandler(e); add_write(fs, "", [294], "Add 3"); } );
}

function fs_error(e) {
  console.log("fs_error:" + e);
}

function get_data(callback) {
  window.webkitRequestFileSystem(window.TEMPORARY,
                                 1024 * 1024,
                                 function(fs) { get_data_fs_init(fs, callback); },
                                 fs_error);
}

function create_or_clear_data() {
  window.webkitRequestFileSystem(window.TEMPORARY,
                                 1024 * 1024,
                                 create_or_clear_fs_init,
                                 fs_error);
}

function add_data(milliseconds, inputtext) {
  window.webkitRequestFileSystem(window.TEMPORARY,
                                 1024 * 1024,
                                 function(fs) { add_data_fs_init(fs, milliseconds, inputtext); },
                                 fs_error);
}

</script>
</body>
</html>
